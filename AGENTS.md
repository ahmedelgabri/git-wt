# What is git-wt

A Go CLI tool that implements the [bare repository worktree pattern](https://gabri.me/blog/git-worktrees-done-right). Instead of a traditional `.git/` directory, the git database lives in `.bare/` and a `.git` **file** (not directory) points to it with `gitdir: ./.bare`. Each branch gets its own sibling worktree directory, so `ls` shows your branches:

```
my-project/
├── .bare/       # git database (bare clone)
├── .git         # file containing "gitdir: ./.bare"
├── main/        # worktree for main branch
└── feature/     # worktree for feature branch
```

## Development Environment

Requires Nix. Enter the dev shell first:

```bash
nix develop
```

## Common Commands

```bash
# Format all files (gofumpt for Go, prettier for md/yml/json/svg, alejandra for nix)
nix fmt

# Run Go unit tests
go test ./...

# Run all E2E tests (auto-builds binary if needed)
bats tests/

# Run a single test file
bats tests/add.bats

# Run a specific test by name
bats tests/add.bats -f "test name pattern"

# Build locally
go build -o git-wt ./cmd/git-wt/

# Build with Nix
nix build

# Run all checks (build + format verification)
nix flake check

# Debug mode - echoes git mutation commands instead of executing
DEBUG=1 ./git-wt add
```

## Architecture

Go CLI built with [cobra](https://github.com/spf13/cobra) for command routing and [fzf](https://github.com/junegunn/fzf) (embedded as a Go library) for interactive fuzzy picking.

### Project Structure

```
cmd/git-wt/main.go          # Entry point
internal/
├── cmd/                     # Cobra command definitions
│   ├── root.go              # Root command, help, pass-throughs
│   ├── clone.go
│   ├── migrate.go
│   ├── add.go
│   ├── remove.go            # Also handles destroy via shared logic
│   ├── destroy.go
│   ├── preview.go           # Hidden _preview command for fzf --preview
│   ├── update.go
│   ├── switch.go
│   ├── list.go
│   └── completion.go        # Shell completion generation
├── git/
│   └── git.go               # Git command runner with DEBUG mode
├── worktree/
│   ├── cache.go             # Worktree cache ([]Entry structs)
│   └── resolve.go           # Path resolution, BareRoot, DefaultBranch
├── picker/                  # fzf-based fuzzy picker (uses fzf Go library)
│   ├── picker.go            # Runs fzf via Input/Output channels
│   └── item.go              # Item, Result, Config types
├── ui/
│   └── ui.go                # Color output with lipgloss, NO_COLOR support
└── fsutil/
    └── copy.go              # Directory copy (replaces rsync)
```

### Key design patterns

- **`git.Run()` vs `git.Query()`**: Mutation operations use `git.Run()` (which becomes a print in DEBUG mode). Read-only operations use `git.Query()` (always runs, even in DEBUG mode).
- **Worktree cache**: `worktree.List()` parses `git worktree list --porcelain` into `[]worktree.Entry` structs.
- **`worktree.Resolve()`**: Central resolver that takes user input (name, relative path, absolute path) and resolves it to a full worktree path.
- **NO_COLOR**: Color output via lipgloss respects the `NO_COLOR` environment variable.
- **Interactive picker**: `internal/picker` embeds fzf as a Go library via `Input`/`Output` channels. Items are formatted as `value\tlabel[ · desc]` with `--with-nth=2..` to hide the value from display while exposing it as `{1}` in `--preview`. Preview content is generated by a hidden `_preview` cobra subcommand that fzf invokes as a subprocess.
- **Pure Go copy**: `internal/fsutil` provides directory copy, replacing rsync.

## Formatting

- Go: gofumpt
- Markdown/YAML/JSON/SVG: prettier
- Nix: alejandra

## Testing

### Go Unit Tests

Each `internal/` package has `_test.go` files. Run with `go test ./...`.

### BATS E2E Tests

Tests use [bats](https://github.com/bats-core/bats-core) (Bash Automated Testing System). Test helpers are in `tests/test_helper.bash`.

Key test fixtures:

- `init_bare_repo [dirname]` - Creates a bare repo with `.bare/` structure (standard for most tests)
- `init_bare_repo_with_remote [dirname]` - Bare repo with a fake origin for testing remote operations
- `init_repo [dirname]` - Standard git repo (for migration tests)
- `init_repo_with_remote [dirname]` - Standard repo with fake origin

All init helpers use `-b main` to ensure deterministic branch naming across environments (CI ubuntu defaults to `master` otherwise).

Each test gets an isolated temp directory via `setup_test_env`/`teardown_test_env`.

The test helper auto-builds the Go binary if it's missing or stale. You can also override with `GIT_WT=/path/to/binary bats tests/`.

## Git Hooks (lefthook)

- **pre-commit**: `go vet` + `nix fmt -- --fail-on-change`
- **pre-push**: `nix build --no-link`

## Distribution

- **Nix Flakes**: `flake.nix` in this repo (uses `buildGoModule`)
- **Homebrew**: separate tap repo at [ahmedelgabri/homebrew-git-wt](https://github.com/ahmedelgabri/homebrew-git-wt)

## Shell Completions

Generated automatically by cobra during the nix build. Supports bash, zsh, and fish.
